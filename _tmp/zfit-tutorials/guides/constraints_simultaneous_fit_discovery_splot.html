
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Combining measurements &#8212; zfit</title>
    
  <link href="../../../_static/css/theme.css" rel="stylesheet" />
  <link href="../../../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/sphinx-book-theme.acff12b8f9c144ce68a297486a2fa670.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/togglebutton.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe,.cell"
        const thebe_selector_input = "pre,.cell_input div.highlight"
        const thebe_selector_output = ".output,.cell_output"
    </script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="../../../_static/zfit-favicon.png"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../../index.html">
      
      
      <h1 class="site-logo" id="site-title">zfit</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../pages/5_minutes_to_zfit.html">
   5 minutes to zfit
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../../_sources/_tmp/zfit-tutorials/guides/constraints_simultaneous_fit_discovery_splot.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/zfit/poster"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/zfit/poster/issues/new?title=Issue%20on%20page%20%2F_tmp/zfit-tutorials/guides/constraints_simultaneous_fit_discovery_splot.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        <a class="edit-button" href="https://github.com/zfit/poster/edit/master/website/_tmp/zfit-tutorials/guides/constraints_simultaneous_fit_discovery_splot.ipynb"><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Edit this page"><i class="fas fa-pencil-alt"></i>suggest edit</button></a>
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/zfit/poster/master?urlpath=lab/tree/website/_tmp/zfit-tutorials/guides/constraints_simultaneous_fit_discovery_splot.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../../../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/zfit/poster/blob/master/website/_tmp/zfit-tutorials/guides/constraints_simultaneous_fit_discovery_splot.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="../../../_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        <button type="button" class="btn btn-secondary topbarbtn"
            onclick="initThebeSBT()" title="Launch Thebe" data-toggle="tooltip" data-placement="left"><i
                class="fas fa-play"></i><span style="margin-left: .4em;">Live Code</span></button>
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#adding-a-constraint">
   Adding a constraint
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#simultaneous-fits">
   Simultaneous fits
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#sharing-and-composing-parameters">
     Sharing and composing parameters
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#independent-parameter">
       Independent parameter
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#dependent-parameter">
       Dependent parameter
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#sharing-parameters">
       Sharing parameters
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plotting-a-simultaneous-loss">
     Plotting a simultaneous loss
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#discovery-test">
   Discovery test
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#upper-limit-calculation">
   Upper limit calculation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#splot">
   Splot
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="combining-measurements">
<h1>Combining measurements<a class="headerlink" href="#combining-measurements" title="Permalink to this headline">¶</a></h1>
<p>When we do a fit, we can have additional knowledge about a parameter from other measurements. This can be taken into account either through a simultaneous fit or by adding a constraint (subsidiary measurement).</p>
<div class="section" id="adding-a-constraint">
<h2>Adding a constraint<a class="headerlink" href="#adding-a-constraint" title="Permalink to this headline">¶</a></h2>
<p>If we know a parameters value from a different measurement and want to constraint this using its uncertainty, a Gaussian constraint can be added to the likelihood as</p>
<div class="amsmath math notranslate nohighlight" id="equation-eff13c9b-08da-4444-9b2e-7cc7fd236cdc">
<span class="eqno">(1)<a class="headerlink" href="#equation-eff13c9b-08da-4444-9b2e-7cc7fd236cdc" title="Permalink to this equation">¶</a></span>\[\begin{align}
\mathrm{constr_i} = \mathrm{Gauss}(\mu_{measured}; \theta_i, \sigma_{measured})
\end{align}\]</div>
<p>In general, additional terms can be added to the likelihood arbitrarily in zfit, be it to incorporate other shaped measurements or to add penalty terms to confine a fit within boundaries.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">hepunits</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">mplhep</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">particle.literals</span> <span class="k">as</span> <span class="nn">lp</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">zfit</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mu_true</span> <span class="o">=</span>  <span class="n">lp</span><span class="o">.</span><span class="n">B_plus</span><span class="o">.</span><span class="n">mass</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">MeV</span>
<span class="n">sigma_true</span> <span class="o">=</span> <span class="mi">50</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">MeV</span>

<span class="c1"># number of signal and background</span>
<span class="n">n_sig_rare</span> <span class="o">=</span> <span class="mi">120</span>
<span class="n">n_bkg_rare</span> <span class="o">=</span> <span class="mi">700</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create some data</span>
<span class="n">signal_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu_true</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma_true</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_sig_rare</span><span class="p">)</span>
<span class="n">bkg_np_raw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">20000</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">700</span><span class="p">)</span>
<span class="n">bkg_np</span> <span class="o">=</span> <span class="n">bkg_np_raw</span><span class="p">[</span><span class="n">bkg_np_raw</span><span class="o">&lt;</span><span class="mi">1000</span><span class="p">][:</span><span class="n">n_bkg_rare</span><span class="p">]</span> <span class="o">+</span> <span class="mi">5000</span>  <span class="c1"># just cutting right, but zfit could also cut</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Firstly, the observable and its range is defined</span>
<span class="n">obs</span> <span class="o">=</span> <span class="n">zfit</span><span class="o">.</span><span class="n">Space</span><span class="p">(</span><span class="s1">&#39;Bmass&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">5000</span><span class="p">,</span> <span class="mi">6000</span><span class="p">))</span>  <span class="c1"># for whole range</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># load data into zfit</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">zfit</span><span class="o">.</span><span class="n">Data</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">obs</span><span class="o">=</span><span class="n">obs</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">signal_np</span><span class="p">,</span> <span class="n">bkg_np</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Parameters are specified:  (name (unique), initial, lower, upper) whereas lower, upper are optional</span>
<span class="n">mu</span> <span class="o">=</span> <span class="n">zfit</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="s1">&#39;mu&#39;</span><span class="p">,</span> <span class="mi">5279</span><span class="p">,</span> <span class="mi">5100</span><span class="p">,</span> <span class="mi">5400</span><span class="p">)</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="n">zfit</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">signal</span> <span class="o">=</span> <span class="n">zfit</span><span class="o">.</span><span class="n">pdf</span><span class="o">.</span><span class="n">Gauss</span><span class="p">(</span><span class="n">mu</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">obs</span><span class="o">=</span><span class="n">obs</span><span class="p">)</span>

<span class="n">lam</span> <span class="o">=</span> <span class="n">zfit</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="s1">&#39;lambda&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.002</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.00001</span><span class="p">,</span> <span class="n">step_size</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>  <span class="c1"># floating, also without limits</span>
<span class="n">comb_bkg</span> <span class="o">=</span> <span class="n">zfit</span><span class="o">.</span><span class="n">pdf</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span> <span class="n">obs</span><span class="o">=</span><span class="n">obs</span><span class="p">)</span>

<span class="n">sig_yield</span> <span class="o">=</span> <span class="n">zfit</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="s1">&#39;sig_yield&#39;</span><span class="p">,</span> <span class="n">n_sig_rare</span> <span class="o">+</span> <span class="mi">30</span><span class="p">,</span>
                                <span class="n">step_size</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># step size: default is small, use appropriate</span>
<span class="n">bkg_yield</span> <span class="o">=</span> <span class="n">zfit</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="s1">&#39;bkg_yield&#39;</span><span class="p">,</span> <span class="n">n_bkg_rare</span> <span class="o">-</span> <span class="mi">40</span><span class="p">,</span> <span class="n">step_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># Create extended PDFs</span>
<span class="n">extended_sig</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">create_extended</span><span class="p">(</span><span class="n">sig_yield</span><span class="p">)</span>
<span class="n">extended_bkg</span> <span class="o">=</span> <span class="n">comb_bkg</span><span class="o">.</span><span class="n">create_extended</span><span class="p">(</span><span class="n">bkg_yield</span><span class="p">)</span>

<span class="c1"># The final model is the combination of the signal and backgrond PDF</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">zfit</span><span class="o">.</span><span class="n">pdf</span><span class="o">.</span><span class="n">SumPDF</span><span class="p">([</span><span class="n">extended_bkg</span><span class="p">,</span> <span class="n">extended_sig</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">constraint</span> <span class="o">=</span> <span class="n">zfit</span><span class="o">.</span><span class="n">constraint</span><span class="o">.</span><span class="n">GaussianConstraint</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">observation</span><span class="o">=</span><span class="mi">5275</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">MeV</span><span class="p">,</span> <span class="n">uncertainty</span><span class="o">=</span><span class="mi">15</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">MeV</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nll</span> <span class="o">=</span> <span class="n">zfit</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">ExtendedUnbinnedNLL</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="n">constraint</span><span class="p">)</span>
<span class="n">minimizer</span> <span class="o">=</span> <span class="n">zfit</span><span class="o">.</span><span class="n">minimize</span><span class="o">.</span><span class="n">Minuit</span><span class="p">(</span><span class="n">use_minuit_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">minimizer</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">nll</span><span class="p">)</span>
<span class="n">result</span><span class="o">.</span><span class="n">hesse</span><span class="p">();</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="simultaneous-fits">
<h2>Simultaneous fits<a class="headerlink" href="#simultaneous-fits" title="Permalink to this headline">¶</a></h2>
<p>Sometimes, we don’t want to fit a single channel but multiple with the same likelihood and having shared parameters between them. In this example, we will fit the decay simultaneously to its resonant control channel.</p>
<p>A simultaneous likelihood is the product of different likelihoods defined by</p>
<div class="amsmath math notranslate nohighlight" id="equation-db1616a0-9fb5-40df-beab-105a20de3ba0">
<span class="eqno">(2)<a class="headerlink" href="#equation-db1616a0-9fb5-40df-beab-105a20de3ba0" title="Permalink to this equation">¶</a></span>\[\begin{align}
\mathcal{L}_{f(x)}(\theta | {data_0, data_1, ..., data_n}) &amp;= \prod_{i=1}^{n} \mathcal{L}(\theta_i, data_i)
\end{align}\]</div>
<p>and becomes in the NLL a sum</p>
<div class="amsmath math notranslate nohighlight" id="equation-f15ec16d-2ae7-48d2-90bf-374d309c3573">
<span class="eqno">(3)<a class="headerlink" href="#equation-f15ec16d-2ae7-48d2-90bf-374d309c3573" title="Permalink to this equation">¶</a></span>\[\begin{align}
\mathrm{NLL}_{f(x)}(\theta | {data_0, data_1, ..., data_n}) &amp;= \sum_{i=1}^{n} \mathrm{NLL}(\theta_i, data_i)
\end{align}\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_sig_reso</span> <span class="o">=</span> <span class="mi">40000</span>
<span class="n">n_bkg_reso</span> <span class="o">=</span> <span class="mi">3000</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create some data</span>
<span class="n">signal_np_reso</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu_true</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma_true</span> <span class="o">*</span> <span class="mf">0.7</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_sig_reso</span><span class="p">)</span>
<span class="n">bkg_np_raw_reso</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">20000</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">900</span><span class="p">)</span>
<span class="n">bkg_np_reso</span> <span class="o">=</span> <span class="n">bkg_np_raw_reso</span><span class="p">[</span><span class="n">bkg_np_raw_reso</span><span class="o">&lt;</span><span class="mi">1000</span><span class="p">][:</span><span class="n">n_bkg_reso</span><span class="p">]</span> <span class="o">+</span> <span class="mi">5000</span>

<span class="c1"># load data into zfit</span>
<span class="n">obs_reso</span> <span class="o">=</span> <span class="n">zfit</span><span class="o">.</span><span class="n">Space</span><span class="p">(</span><span class="s1">&#39;Bmass_reso&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">5000</span><span class="p">,</span> <span class="mi">6000</span><span class="p">))</span>
<span class="n">data_reso</span> <span class="o">=</span> <span class="n">zfit</span><span class="o">.</span><span class="n">Data</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">obs</span><span class="o">=</span><span class="n">obs_reso</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">signal_np_reso</span><span class="p">,</span> <span class="n">bkg_np_reso</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="sharing-and-composing-parameters">
<h3>Sharing and composing parameters<a class="headerlink" href="#sharing-and-composing-parameters" title="Permalink to this headline">¶</a></h3>
<p>As an example, the same signal shape will be used with the identical <code class="docutils literal notranslate"><span class="pre">mu</span></code> yet a scaled <code class="docutils literal notranslate"><span class="pre">sigma</span></code>. This means that the <code class="docutils literal notranslate"><span class="pre">sigma</span></code> of our control mode corresponds to the <code class="docutils literal notranslate"><span class="pre">sigma</span></code> of our signal times a scaling parameter. Therefore, the <code class="docutils literal notranslate"><span class="pre">scaled_sigma</span></code> is a function of two other parameters, <code class="docutils literal notranslate"><span class="pre">sigma</span></code> and <code class="docutils literal notranslate"><span class="pre">sigma_scaling</span></code> and <em>cannot</em> change it’s value independently. There are two fundamentally distinct types to represent this behavior in zfit, independent (<code class="docutils literal notranslate"><span class="pre">Parameter</span></code>) and dependent parameters (<code class="docutils literal notranslate"><span class="pre">ComplexParameter</span></code>, <code class="docutils literal notranslate"><span class="pre">ComposedParameter</span></code>,…)</p>
<div class="section" id="independent-parameter">
<h4>Independent parameter<a class="headerlink" href="#independent-parameter" title="Permalink to this headline">¶</a></h4>
<p>An independent parameter has, as a distinctive method, a <code class="docutils literal notranslate"><span class="pre">set_value</span></code> that <em>changes</em> the value of the parameter. In a fit, or in general, these are <em>the only object</em> that can directly change their value and therefore do not depend on other objects while most other objects depend on Parameters.
As a consequence, this parameters can have limits (which effectively restrict the possible values a <code class="docutils literal notranslate"><span class="pre">Parameter</span></code> can be assigned to) and have a <code class="docutils literal notranslate"><span class="pre">step_size</span></code>, a hint to any minimization algorithm about the order of magnitude that a change in the parameter will have on the loss.</p>
<p>Another attribute is a <code class="docutils literal notranslate"><span class="pre">floating</span></code> flag: if set to <code class="docutils literal notranslate"><span class="pre">False</span></code>, the parameter won’t be floating in the fit, whether explicitly given or implicitly inferred from the dependencies.</p>
</div>
<div class="section" id="dependent-parameter">
<h4>Dependent parameter<a class="headerlink" href="#dependent-parameter" title="Permalink to this headline">¶</a></h4>
<p>These are single-valued functions effectively that depend on other objects, usually other parameters. Therefore, a dependent parameter does not have a <code class="docutils literal notranslate"><span class="pre">set_value</span></code> function and also does not posses limits. The latter is preferred to be set with the <code class="docutils literal notranslate"><span class="pre">Parameter</span></code> it depends on, however, if a hard limit is required, this can always be enforced in the definition of a <code class="docutils literal notranslate"><span class="pre">ComposedParameter</span></code>.</p>
<p>The most notable parameter is the <code class="docutils literal notranslate"><span class="pre">ComposedParameter</span></code>, which returns an arbitrary function of its input arguments, the latter which can be specified with the <code class="docutils literal notranslate"><span class="pre">params</span></code> argument.</p>
<p>While this parameters <em>cannot</em> change there value explicitly and therefore won’t be used by a minimizer, the zfit minimizers automatically extract the independent parameters that a dependent parameter depends on (if this is given as an argument.)</p>
<p>As a consequence, these parameters also miss a <code class="docutils literal notranslate"><span class="pre">step_size</span></code> attribute. Furthermore, <code class="docutils literal notranslate"><span class="pre">floating</span></code> can’t be used, neither set nor retrieved; it is rather advised to check directly with its dependencies.</p>
</div>
<div class="section" id="sharing-parameters">
<h4>Sharing parameters<a class="headerlink" href="#sharing-parameters" title="Permalink to this headline">¶</a></h4>
<p>Since in zfit, every parameter object is unique, also defined by its name, it is straightforward to know when a parameter is shared in the loss and when it is not: if the same object is used in two places, it is shared. This can be arbitrarily mixed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Firstly, we create a free scaling parameter</span>
<span class="n">sigma_scaling</span> <span class="o">=</span> <span class="n">zfit</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="s1">&#39;sigma_scaling&#39;</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">step_size</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">sigma_scaled_fn</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">sigma_scaling</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">sigma_scaling</span>  <span class="c1"># this can be an arbitrary function</span>


<span class="n">sigma_scaled</span> <span class="o">=</span> <span class="n">zfit</span><span class="o">.</span><span class="n">ComposedParameter</span><span class="p">(</span><span class="s1">&#39;sigma scaled&#39;</span><span class="p">,</span>  <span class="c1"># name</span>
                                      <span class="n">sigma_scaled_fn</span><span class="p">,</span>  <span class="c1"># function</span>
                                      <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="n">sigma</span><span class="p">,</span> <span class="n">sigma_scaling</span><span class="p">]</span>  <span class="c1"># the objects used inside the function</span>
                                      <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">signal_reso</span> <span class="o">=</span> <span class="n">zfit</span><span class="o">.</span><span class="n">pdf</span><span class="o">.</span><span class="n">Gauss</span><span class="p">(</span><span class="n">mu</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span>  <span class="c1"># the same as for the rare mode</span>
                             <span class="n">sigma</span><span class="o">=</span><span class="n">sigma_scaled</span><span class="p">,</span>
                             <span class="n">obs</span><span class="o">=</span><span class="n">obs_reso</span>
                            <span class="p">)</span>

<span class="n">lambda_reso</span> <span class="o">=</span> <span class="n">zfit</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="s1">&#39;lambda_reso&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.002</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">)</span>  <span class="c1"># floating</span>
<span class="n">comb_bkg_reso_pdf</span> <span class="o">=</span> <span class="n">zfit</span><span class="o">.</span><span class="n">pdf</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">lambda_reso</span><span class="p">,</span> <span class="n">obs</span><span class="o">=</span><span class="n">obs_reso</span><span class="p">)</span>

<span class="n">reso_sig_yield</span> <span class="o">=</span> <span class="n">zfit</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="s1">&#39;reso_sig_yield&#39;</span><span class="p">,</span> <span class="n">n_sig_reso</span> <span class="o">-</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n_sig_reso</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span>
                                <span class="n">step_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># step size: default is small, use appropriate</span>
<span class="n">reso_bkg_yield</span> <span class="o">=</span> <span class="n">zfit</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="s1">&#39;reso_bkg_yield&#39;</span><span class="p">,</span> <span class="n">n_bkg_reso</span> <span class="o">+</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">2e5</span><span class="p">,</span> <span class="n">step_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Create the extended models</span>
<span class="n">extended_sig_reso</span> <span class="o">=</span> <span class="n">signal_reso</span><span class="o">.</span><span class="n">create_extended</span><span class="p">(</span><span class="n">reso_sig_yield</span><span class="p">)</span>
<span class="n">extended_bkg_reso</span> <span class="o">=</span> <span class="n">comb_bkg_reso_pdf</span><span class="o">.</span><span class="n">create_extended</span><span class="p">(</span><span class="n">reso_bkg_yield</span><span class="p">)</span>
<span class="n">model_reso</span> <span class="o">=</span> <span class="n">zfit</span><span class="o">.</span><span class="n">pdf</span><span class="o">.</span><span class="n">SumPDF</span><span class="p">([</span><span class="n">extended_bkg_reso</span><span class="p">,</span> <span class="n">extended_sig_reso</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>To implement the simultaneous fit, there are two ways to achieve this in zfit. As an important distinction to other frameworks, zfit translates the above equation</p>
<div class="amsmath math notranslate nohighlight" id="equation-9b41746b-6f20-4dd9-802d-d0e4572f418b">
<span class="eqno">(4)<a class="headerlink" href="#equation-9b41746b-6f20-4dd9-802d-d0e4572f418b" title="Permalink to this equation">¶</a></span>\[\begin{align}
\mathrm{NLL}_{f(x)}(\theta | {data_0, data_1, ..., data_n}) &amp;= \sum_{i=1}^{n} \mathrm{NLL}(\theta_i, data_i)
\end{align}\]</div>
<p>directly into code.</p>
<p>We can build two losses and add them directly or give a list of models and data, which build a loss each one and add up.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nll_rare</span> <span class="o">=</span> <span class="n">zfit</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">ExtendedUnbinnedNLL</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">nll_reso</span> <span class="o">=</span> <span class="n">zfit</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">ExtendedUnbinnedNLL</span><span class="p">(</span><span class="n">model_reso</span><span class="p">,</span> <span class="n">data_reso</span><span class="p">)</span>
<span class="n">nll_simultaneous</span> <span class="o">=</span> <span class="n">nll_rare</span> <span class="o">+</span> <span class="n">nll_reso</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result_simultaneous</span> <span class="o">=</span> <span class="n">minimizer</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">nll_simultaneous</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result_simultaneous</span><span class="o">.</span><span class="n">hesse</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">result_simultaneous</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="plotting-a-simultaneous-loss">
<h3>Plotting a simultaneous loss<a class="headerlink" href="#plotting-a-simultaneous-loss" title="Permalink to this headline">¶</a></h3>
<p>Since the definition of a simultaneous fit is as above, it is simple to plot each component separately: either my using the attributes of the loss to access the models and plot in a general fashion or directly reuse the model and data from before; we created them manually before.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Sets the values of the parameters to the result of the simultaneous fit</span>
<span class="c1"># in case they were modified.</span>
<span class="n">zfit</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span><span class="n">nll_simultaneous</span><span class="o">.</span><span class="n">get_params</span><span class="p">(),</span> <span class="n">result_simultaneous</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">plot_fit_projection</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># The function will be reused.</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

    <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">data_range</span><span class="o">.</span><span class="n">limit1d</span>

    <span class="c1"># Creates and histogram of the data and plots it with mplhep.</span>
    <span class="n">counts</span><span class="p">,</span> <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">unstack_x</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="n">nbins</span><span class="p">)</span>
    <span class="n">mplhep</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bin_edges</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s2">&quot;errorbar&quot;</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>

    <span class="n">binwidth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>  <span class="c1"># or np.linspace</span>

    <span class="c1"># Line plots of the total pdf and the sub-pdfs.</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">ext_pdf</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">binwidth</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;total&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;royalblue&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">get_models</span><span class="p">(),</span> <span class="p">[</span><span class="s2">&quot;background&quot;</span><span class="p">,</span> <span class="s2">&quot;signal&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;forestgreen&quot;</span><span class="p">,</span> <span class="s2">&quot;crimson&quot;</span><span class="p">]):</span>
        <span class="n">ym</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">ext_pdf</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">binwidth</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ym</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">l</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">data_range</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ax</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="k">for</span> <span class="n">mod</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">nb</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">nll_simultaneous</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">nll_simultaneous</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">axs</span><span class="p">,</span> <span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mi">60</span><span class="p">]):</span>
    <span class="n">plot_fit_projection</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">dat</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="n">nb</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="discovery-test">
<h2>Discovery test<a class="headerlink" href="#discovery-test" title="Permalink to this headline">¶</a></h2>
<p>We observed an excess of our signal:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">result_simultaneous</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">sig_yield</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>Now we would like to compute the significance of this observation or in other words the probabilty that this observation is the result of the statistical fluctuation. To do so we have to perform an hypothesis test where the null and alternative hypotheses are defined as:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(H_{0}\)</span>, the null or background only hypothesis, i.e. <span class="math notranslate nohighlight">\(N_{sig} = 0\)</span>;</p></li>
<li><p><span class="math notranslate nohighlight">\(H_{1}\)</span>, the alternative hypothesis, i.e <span class="math notranslate nohighlight">\(N_{sig} = \hat{N}_{sig}\)</span>, where <span class="math notranslate nohighlight">\(\hat{N}_{sig}\)</span> is the fitted value of <span class="math notranslate nohighlight">\(N_{sig}\)</span> printed above.</p></li>
</ul>
<p>In <code class="docutils literal notranslate"><span class="pre">hepstats</span></code> to formulate a hypothesis you have to use the <code class="docutils literal notranslate"><span class="pre">POI</span></code> (Parameter Of Interest) class.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">hepstats.hypotests.parameters</span> <span class="kn">import</span> <span class="n">POI</span>

<span class="c1"># the null hypothesis</span>
<span class="n">sig_yield_poi</span> <span class="o">=</span> <span class="n">POI</span><span class="p">(</span><span class="n">sig_yield</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>What the <code class="docutils literal notranslate"><span class="pre">POI</span></code> class does is to take as input a <code class="docutils literal notranslate"><span class="pre">zfit.Parameter</span></code> instance and a value corresponding to a given hypothesis. You can notice that we didn’t define here the alternative hypothesis as in the discovery test the value of POI for alternate is set to the best fit value.</p>
<p>The test statistic used is the profile likelihood ratio and defined as:</p>
<div class="amsmath math notranslate nohighlight" id="equation-8a8dd091-7aad-429d-a8ab-e665009e6131">
<span class="eqno">(5)<a class="headerlink" href="#equation-8a8dd091-7aad-429d-a8ab-e665009e6131" title="Permalink to this equation">¶</a></span>\[\begin{equation}
q_{0} = \left\{
    \begin{array}{ll}
        -2 \ln \frac{\mathcal{L}(N_{sig}=0, \; \hat{\hat{\theta}})}{\mathcal{L}(N_{sig}=\hat{N}_{sig}, \; \hat{\theta})} &amp; \mbox{if } \; \hat{N}_{sig} \geq 0 \\
        0 &amp; \mbox{if } \; \hat{N}_{sig} &lt; 0
    \end{array}
\right.
\end{equation}\]</div>
<p>where <span class="math notranslate nohighlight">\(\hat{\theta}\)</span> are the best fitted values of the nuisances parameters (i.e. background yield, exponential slope…), while <span class="math notranslate nohighlight">\(\hat{\hat{\theta}}\)</span> are the fitted values of the nuisances when <span class="math notranslate nohighlight">\({N}_{sig} = 0\)</span>.</p>
<p>From the test statistic distribution a p-value can computed as</p>
<div class="amsmath math notranslate nohighlight" id="equation-29ea6350-6e85-43ad-9337-94e19b966087">
<span class="eqno">(6)<a class="headerlink" href="#equation-29ea6350-6e85-43ad-9337-94e19b966087" title="Permalink to this equation">¶</a></span>\[\begin{equation}
p_{0} = \int_{q_{0}^{obs}}^{\infty} f(q_{0} |H_{0}) dq_{0}
\end{equation}\]</div>
<p>where <span class="math notranslate nohighlight">\(q_{0}^{obs}\)</span> is the value of the test statistic evaluated on observed data.</p>
<p>The construction of the test statistic and the computation of the p-value is done in a <code class="docutils literal notranslate"><span class="pre">Calculator</span></code> object in <code class="docutils literal notranslate"><span class="pre">hepstats</span></code>. In this example we will use in this example the <code class="docutils literal notranslate"><span class="pre">AsymptoticCalculator</span></code> calculator which assumes that <span class="math notranslate nohighlight">\(q_{0}\)</span> follows a <span class="math notranslate nohighlight">\(\chi^2(ndof=1)\)</span> which simplifies the p-value computation to</p>
<div class="amsmath math notranslate nohighlight" id="equation-31555d23-d7d7-4e0d-a927-5d109c40d0ba">
<span class="eqno">(7)<a class="headerlink" href="#equation-31555d23-d7d7-4e0d-a927-5d109c40d0ba" title="Permalink to this equation">¶</a></span>\[\begin{equation}
p_{0} = 1 - \Phi\bigg({\sqrt{q_{0}^{obs}}}\bigg).
\end{equation}\]</div>
<p>The calculator objects takes as input the likelihood function and a minimizer to profile the likelihood.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">hepstats.hypotests.calculators</span> <span class="kn">import</span> <span class="n">AsymptoticCalculator</span>

<span class="c1"># construction of the calculator instance</span>
<span class="n">calculator</span> <span class="o">=</span> <span class="n">AsymptoticCalculator</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">nll_simultaneous</span><span class="p">,</span> <span class="n">minimizer</span><span class="o">=</span><span class="n">minimizer</span><span class="p">)</span>
<span class="n">calculator</span><span class="o">.</span><span class="n">bestfit</span> <span class="o">=</span> <span class="n">result_simultaneous</span>

<span class="c1"># equivalent to above</span>
<span class="n">calculator</span> <span class="o">=</span> <span class="n">AsymptoticCalculator</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">result_simultaneous</span><span class="p">,</span> <span class="n">minimizer</span><span class="o">=</span><span class="n">minimizer</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>There is another calculator in <code class="docutils literal notranslate"><span class="pre">hepstats</span></code> called <code class="docutils literal notranslate"><span class="pre">FrequentistCalculator</span></code> which constructs the test statistic distribution <span class="math notranslate nohighlight">\(f(q_{0} |H_{0})\)</span> with pseudo-experiments (toys), but it takes more time.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Discovery</span></code> class is a high-level class that takes as input a calculator and a <code class="docutils literal notranslate"><span class="pre">POI</span></code> instance representing the null hypothesis, it basically asks the calculator to compute the p-value and also computes the signifance as</p>
<div class="amsmath math notranslate nohighlight" id="equation-f240652e-ea49-43ac-b656-5abdc0657ae5">
<span class="eqno">(8)<a class="headerlink" href="#equation-f240652e-ea49-43ac-b656-5abdc0657ae5" title="Permalink to this equation">¶</a></span>\[\begin{equation}
Z = \Phi^{-1}(1 - p_0).
\end{equation}\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">hepstats.hypotests</span> <span class="kn">import</span> <span class="n">Discovery</span>

<span class="n">discovery</span> <span class="o">=</span> <span class="n">Discovery</span><span class="p">(</span><span class="n">calculator</span><span class="o">=</span><span class="n">calculator</span><span class="p">,</span> <span class="n">poinull</span><span class="o">=</span><span class="n">sig_yield_poi</span><span class="p">)</span>
<span class="n">discovery</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>So we get a significance of about <span class="math notranslate nohighlight">\(7\sigma\)</span> which is well above the <span class="math notranslate nohighlight">\(5 \sigma\)</span> threshold for discoveries 😃.</p>
</div>
<div class="section" id="upper-limit-calculation">
<h2>Upper limit calculation<a class="headerlink" href="#upper-limit-calculation" title="Permalink to this headline">¶</a></h2>
<p>Let’s try to compute the discovery significance with a lower number of generated signal events.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Sets the values of the parameters to the result of the simultaneous fit</span>
<span class="n">zfit</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span><span class="n">nll_simultaneous</span><span class="o">.</span><span class="n">get_params</span><span class="p">(),</span> <span class="n">result_simultaneous</span><span class="p">)</span>
<span class="n">sigma_scaling</span><span class="o">.</span><span class="n">floating</span><span class="o">=</span><span class="kc">False</span>

<span class="c1"># Creates a sampler that will draw events from the model</span>
<span class="n">sampler</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">create_sampler</span><span class="p">()</span>

<span class="c1"># Creates new simultaneous loss</span>
<span class="n">nll_simultaneous_low_sig</span> <span class="o">=</span> <span class="n">zfit</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">ExtendedUnbinnedNLL</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">sampler</span><span class="p">)</span> <span class="o">+</span> <span class="n">nll_reso</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Samples with sig_yield = 10. Since the model is extended the number of</span>
<span class="c1"># signal generated is drawn from a poisson distribution with lambda = 10.</span>
<span class="n">sampler</span><span class="o">.</span><span class="n">resample</span><span class="p">({</span><span class="n">sig_yield</span><span class="p">:</span> <span class="mi">10</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">calculator_low_sig</span> <span class="o">=</span> <span class="n">AsymptoticCalculator</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">nll_simultaneous_low_sig</span><span class="p">,</span> <span class="n">minimizer</span><span class="o">=</span><span class="n">minimizer</span><span class="p">)</span>

<span class="n">discovery_low_sig</span> <span class="o">=</span> <span class="n">Discovery</span><span class="p">(</span><span class="n">calculator</span><span class="o">=</span><span class="n">calculator_low_sig</span><span class="p">,</span> <span class="n">poinull</span><span class="o">=</span><span class="n">sig_yield_poi</span><span class="p">)</span>
<span class="n">discovery_low_sig</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">calculator_low_sig</span><span class="o">.</span><span class="n">bestfit</span><span class="o">.</span><span class="n">params</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We might consider computing an upper limit on the signal yield instead. The test statistic for an upper limit calculation is</p>
<div class="amsmath math notranslate nohighlight" id="equation-f65d540a-51f7-4f65-bb00-c68e9fb04af8">
<span class="eqno">(9)<a class="headerlink" href="#equation-f65d540a-51f7-4f65-bb00-c68e9fb04af8" title="Permalink to this equation">¶</a></span>\[\begin{equation}
q_{N_{sig}} = \left\{
    \begin{array}{ll}
        -2 \ln \frac{\mathcal{L}(N_{sig}, \; \hat{\hat{\theta}})}{\mathcal{L}(N_{sig}=\hat{N}_{sig}, \; \hat{\theta})} &amp; \mbox{if } \; \hat{N}_{sig} \leq N_{sig} \\
        0 &amp; \mbox{if } \; \hat{N}_{sig} &gt; N_{sig}.
    \end{array}
\right.
\end{equation}\]</div>
<p>and the p-value is</p>
<div class="amsmath math notranslate nohighlight" id="equation-19571aa4-ca7a-47d6-9ca4-649e619fe00f">
<span class="eqno">(10)<a class="headerlink" href="#equation-19571aa4-ca7a-47d6-9ca4-649e619fe00f" title="Permalink to this equation">¶</a></span>\[\begin{equation}
p_{N_{sig}} = \int_{q_{N_{sig}}^{obs}}^{\infty} f(q_{N_{sig}} |N_{sig}) dq_{N_{sig}}.
\end{equation}\]</div>
<p>The upper limit on <span class="math notranslate nohighlight">\(N_{sig}\)</span>, <span class="math notranslate nohighlight">\(N_{sig, \uparrow}\)</span> is found for <span class="math notranslate nohighlight">\(p_{N_{sig, \uparrow}} = 1 - \alpha\)</span>, <span class="math notranslate nohighlight">\(\alpha\)</span> being the confidence level (typically <span class="math notranslate nohighlight">\(95 \%\)</span>). The upper limit is found by interpolation of the p-values as a function of <span class="math notranslate nohighlight">\(N_{sig}\)</span>, which is done the <code class="docutils literal notranslate"><span class="pre">UpperLimit</span></code> class. We have to give the range of values of <span class="math notranslate nohighlight">\(N_{sig}\)</span> to scan using the <code class="docutils literal notranslate"><span class="pre">POIarray</span></code> class which as the <code class="docutils literal notranslate"><span class="pre">POI</span></code> class takes as input the parameter but takes several values to evaluate the parameter instead of one.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">hepstats.hypotests</span> <span class="kn">import</span> <span class="n">UpperLimit</span>
<span class="kn">from</span> <span class="nn">hepstats.hypotests.parameters</span> <span class="kn">import</span> <span class="n">POIarray</span>

<span class="c1"># Background only hypothesis.</span>
<span class="n">bkg_only</span> <span class="o">=</span> <span class="n">POI</span><span class="p">(</span><span class="n">sig_yield</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="c1"># Range of Nsig values to scan.</span>
<span class="n">sig_yield_scan</span> <span class="o">=</span> <span class="n">POIarray</span><span class="p">(</span><span class="n">sig_yield</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="n">ul</span> <span class="o">=</span> <span class="n">UpperLimit</span><span class="p">(</span><span class="n">calculator</span><span class="o">=</span><span class="n">calculator_low_sig</span><span class="p">,</span> <span class="n">poinull</span><span class="o">=</span><span class="n">sig_yield_scan</span><span class="p">,</span> <span class="n">poialt</span><span class="o">=</span><span class="n">bkg_only</span><span class="p">)</span>
<span class="n">ul</span><span class="o">.</span><span class="n">upperlimit</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">plotlimit</span>

<span class="n">plotlimit</span><span class="p">(</span><span class="n">ul</span><span class="p">,</span> <span class="n">CLs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="splot">
<h2>Splot<a class="headerlink" href="#splot" title="Permalink to this headline">¶</a></h2>
<p>This is now an demonstration of the <strong>sPlot</strong> algorithm, described in <a class="reference external" href="https://arxiv.org/pdf/physics/0402083.pdf">Pivk:2004ty</a>.</p>
<p>If a data sample is populated by different sources of events, like signal and background, <strong>sPlot</strong> is able to unfold the contributions of the different sources for a given variable.</p>
<p>Let’s construct a dataset with two variables, the invariant mass and lifetime, for the resonant signal defined above and the combinatorial background.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Signal distributions.</span>
<span class="n">nsig_sw</span> <span class="o">=</span> <span class="mi">20000</span>
<span class="n">np_sig_m_sw</span> <span class="o">=</span> <span class="n">signal_reso</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">nsig_sw</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)</span>
<span class="n">np_sig_t_sw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">nsig_sw</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Background distributions.</span>
<span class="n">nbkg_sw</span> <span class="o">=</span> <span class="mi">150000</span>
<span class="n">np_bkg_m_sw</span> <span class="o">=</span> <span class="n">comb_bkg_reso_pdf</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">nbkg_sw</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)</span>
<span class="n">np_bkg_t_sw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">nbkg_sw</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>

<span class="c1"># Lifetime cut.</span>
<span class="n">t_cut</span> <span class="o">=</span> <span class="n">np_bkg_t_sw</span> <span class="o">&gt;</span> <span class="mi">0</span>
<span class="n">np_bkg_t_sw</span> <span class="o">=</span> <span class="n">np_bkg_t_sw</span><span class="p">[</span><span class="n">t_cut</span><span class="p">]</span>
<span class="n">np_bkg_m_sw</span> <span class="o">=</span> <span class="n">np_bkg_m_sw</span><span class="p">[</span><span class="n">t_cut</span><span class="p">]</span>

<span class="c1"># Mass distribution</span>
<span class="n">np_m_sw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np_sig_m_sw</span><span class="p">,</span> <span class="n">np_bkg_m_sw</span><span class="p">])</span>

<span class="c1"># Lifetime distribution</span>
<span class="n">np_t_sw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np_sig_t_sw</span><span class="p">,</span> <span class="n">np_bkg_t_sw</span><span class="p">])</span>

<span class="c1"># Plots the mass and lifetime distribution.</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">([</span><span class="n">np_bkg_m_sw</span><span class="p">,</span> <span class="n">np_sig_m_sw</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">stacked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;background&quot;</span><span class="p">,</span> <span class="s2">&quot;signal&quot;</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.7</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">([</span><span class="n">np_bkg_t_sw</span><span class="p">,</span> <span class="n">np_sig_t_sw</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">stacked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;background&quot;</span><span class="p">,</span> <span class="s2">&quot;signal&quot;</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.7</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<p>In this particular example we want to unfold the signal lifetime distribution. To do so <strong>sPlot</strong> needs a discriminant variable to determine the yields of the various sources using an <ins>extended</ins> maximum likelihood fit.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Builds the loss.</span>
<span class="n">data_sw</span> <span class="o">=</span> <span class="n">zfit</span><span class="o">.</span><span class="n">Data</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">obs</span><span class="o">=</span><span class="n">obs_reso</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="n">np_m_sw</span><span class="p">)</span>
<span class="n">nll_sw</span> <span class="o">=</span> <span class="n">zfit</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">ExtendedUnbinnedNLL</span><span class="p">(</span><span class="n">model_reso</span><span class="p">,</span> <span class="n">data_sw</span><span class="p">)</span>

<span class="c1"># This parameter was useful in the simultaneous fit but not anymore so we fix it.</span>
<span class="n">sigma_scaling</span><span class="o">.</span><span class="n">floating</span><span class="o">=</span><span class="kc">False</span>

<span class="c1"># Minimizes the loss.</span>
<span class="n">result_sw</span> <span class="o">=</span> <span class="n">minimizer</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">nll_sw</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result_sw</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Visualization of the result.</span>
<span class="n">zfit</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span><span class="n">nll_sw</span><span class="o">.</span><span class="n">get_params</span><span class="p">(),</span> <span class="n">result_sw</span><span class="p">)</span>
<span class="n">plot_fit_projection</span><span class="p">(</span><span class="n">model_reso</span><span class="p">,</span> <span class="n">data_sw</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>sPlot</strong> will use the fitted yield for each sources to derive the so-called <strong>sWeights</strong> for each data point:</p>
<div class="amsmath math notranslate nohighlight" id="equation-095f55ad-d474-4185-adf6-d850486028c0">
<span class="eqno">(11)<a class="headerlink" href="#equation-095f55ad-d474-4185-adf6-d850486028c0" title="Permalink to this equation">¶</a></span>\[\begin{equation}
W_{n}(x) = \frac{\sum_{j=1}^{N_S} V_{nj} f_j(x)}{\sum_{k=1}^{N_S} N_{k}f_k(x)}
\end{equation}\]</div>
<p>with</p>
<div class="amsmath math notranslate nohighlight" id="equation-2ef3e913-73d0-4c1f-a821-db37b909aa37">
<span class="eqno">(12)<a class="headerlink" href="#equation-2ef3e913-73d0-4c1f-a821-db37b909aa37" title="Permalink to this equation">¶</a></span>\[\begin{equation}
V_{nj}^{-1} = \sum_{e=1}^{N} \frac{f_n(x_e) f_j(x_e)}{(\sum_{k=1}^{N_S} N_{k}f_k(x))^2}
\end{equation}\]</div>
<p>where <span class="math notranslate nohighlight">\({N_S}\)</span> is the number of sources in the data sample, here 2. The index <span class="math notranslate nohighlight">\(n\)</span> represents the source, for instance <span class="math notranslate nohighlight">\(0\)</span> is the signal and <span class="math notranslate nohighlight">\(1\)</span> is the background, then <span class="math notranslate nohighlight">\(f_0\)</span> and <span class="math notranslate nohighlight">\(N_0\)</span> are the pdf and yield for the signal.</p>
<p>In <code class="docutils literal notranslate"><span class="pre">hepstats</span></code> the <strong>sWeights</strong> are computed with the <code class="docutils literal notranslate"><span class="pre">compute_sweights</span></code> function which takes as arguments the <ins>fitted</ins> extended model and the discrimant data (on which the fit was performed).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">hepstats.splot</span> <span class="kn">import</span> <span class="n">compute_sweights</span>

<span class="n">weights</span> <span class="o">=</span> <span class="n">compute_sweights</span><span class="p">(</span><span class="n">model_reso</span><span class="p">,</span> <span class="n">data_sw</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sum of signal sWeights: &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">reso_sig_yield</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sum of background sWeights: &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">reso_bkg_yield</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
<p>Now we can apply the signal <strong>sWeights</strong> on the lifetime distribution and retrieve its signal components.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">nbins</span> <span class="o">=</span> <span class="mi">40</span>

<span class="n">sorter</span> <span class="o">=</span> <span class="n">np_m_sw</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np_m_sw</span><span class="p">[</span><span class="n">sorter</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="n">reso_sig_yield</span><span class="p">][</span><span class="n">sorter</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$w_</span><span class="se">\\</span><span class="s2">mathrm</span><span class="si">{sig}</span><span class="s2">$&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np_m_sw</span><span class="p">[</span><span class="n">sorter</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="n">reso_bkg_yield</span><span class="p">][</span><span class="n">sorter</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$w_</span><span class="se">\\</span><span class="s2">mathrm</span><span class="si">{bkg}</span><span class="s2">$&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np_m_sw</span><span class="p">[</span><span class="n">sorter</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="n">reso_sig_yield</span><span class="p">][</span><span class="n">sorter</span><span class="p">]</span> <span class="o">+</span> <span class="n">weights</span><span class="p">[</span><span class="n">reso_bkg_yield</span><span class="p">][</span><span class="n">sorter</span><span class="p">],</span>
            <span class="s2">&quot;-k&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$w_</span><span class="se">\\</span><span class="s2">mathrm</span><span class="si">{sig}</span><span class="s2"> + w_</span><span class="se">\\</span><span class="s2">mathrm</span><span class="si">{bkg}</span><span class="s2">$&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;0.5&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span> <span class="mi">5600</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">np_t_sw</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">nbins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">[</span><span class="n">reso_sig_yield</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;weighted histogram&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.5</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">np_sig_t_sw</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">nbins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">histtype</span><span class="o">=</span><span class="s2">&quot;step&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;true histogram&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<p>Be careful the <strong>sPlot</strong> technique works only on variables that are uncorrelated with the discriminant variable.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Correlation between m and t: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">np_m_sw</span><span class="p">,</span> <span class="n">np_t_sw</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s apply to signal <strong>sWeights</strong> on the mass distribution to see how bad the results of <strong>sPlot</strong> is when applied on a variable that is correlated with the discrimant variable.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">np_m_sw</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span> <span class="mi">6000</span><span class="p">),</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">[</span><span class="n">reso_sig_yield</span><span class="p">]);</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "zfit/poster",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./_tmp/zfit-tutorials/guides"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By zfit<br/>
        
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../../../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>